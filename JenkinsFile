pipeline {
    agent any

    environment {
        APP_NAME = 'sicei'
        NEW_APP_NAME = "${APP_NAME}:${BUILD_ID}"
    }

    stages {
        stage('Build') {
            steps {
                echo 'üîß Verificando si Docker est√° corriendo...'
                sh '''
                    if ! pgrep -x "dockerd" > /dev/null; then
                      echo "üöÄ Docker no est√° corriendo. Iniciando Docker..."
                      open -a Docker  # Para macOS
                      sleep 10
                    fi
                '''

                echo 'üê≥ Construyendo la imagen Docker...'
                sh '''
                    docker build -t $NEW_APP_NAME .
                '''
            }
        }

        stage('Deploy') {
            steps {
                echo 'üöÄ Desplegando la aplicaci√≥n...'
                sh '''
                    EXISTING_CONTAINER=$(docker ps -q -f name=$APP_NAME)

                    if [ -n "$EXISTING_CONTAINER" ]; then
                        echo "Deteniendo contenedor existente..."
                        docker stop $APP_NAME
                        echo "Eliminando contenedor existente..."
                        docker rm -f $APP_NAME
                    fi

                    EXISTING_CONTAINER=$(docker ps -aq -f name=$APP_NAME)
                    if [ -n "$EXISTING_CONTAINER" ]; then
                        echo "‚ùå Error: El contenedor anterior no se elimin√≥ correctamente."
                        exit 1
                    fi

                    echo "üö¢ Ejecutando nuevo contenedor..."
                    docker run -d -p 3000:3000 --name "$APP_NAME" "$NEW_APP_NAME"
                '''
                echo "‚úÖ Despliegue exitoso."
            }
        }
    }
}
